sap.ui.define(["./BaseController","sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/MessageToast","com/dhi/cms/cmsrequester/util/transaction/ContractManager","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/ui/core/BusyIndicator"],(t,e,a,o,i,r,n,s,c)=>{"use strict";return t.extend("com.dhi.cms.cmsrequester.controller.ContractDetails",{onInit(){this.getRouter().getRoute("ContractDetails").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(t){c.show(0);this.basicVaditionIds=["contractTitleInput","contractTypeSelect","contractaliasInput","contractdescriptionInput"];this.clearValidationStates(this.basicVaditionIds);this._SelectedContractType;const e=t.getParameter("arguments");this.contractId=e.contractId;const a=t.getParameter("name");const o=!!this.contractId;this._oIconTabBar=this.byId("iconTabBar");if(!this.contractId){this._initializeContractMasters()}else{this._getContractDetails()}this._focusOnBasicInfoTab();const i=this.getView();i.setModel(r.getMessageModel(),"message");r.removeAllMessages();c.hide()},_initializeContractMasters:function(){const t={ID:null,alias:null,contract_id:null,description:null,end_date:null,is_visible:true,name:null,start_date:null,templates_ID:null,attribute_values:[],attachments:[]};this.getModel("contractModel").setData(t)},_getContractDetails:async function(){let t=this.getModel();let e="/Contracts('"+this.contractId+"')";let a=t.bindContext(e,undefined,{$expand:"attribute_values,attachments"});let o=await a.requestObject().then(function(t){console.log(t);return t});this.contractData=o;this.getModel("contractModel").setData(o);this.getModel("appModel").setProperty("/status",o.status)},_focusOnBasicInfoTab:function(){const t=this.byId("iconTabBar");t.setSelectedKey("BasicInfo");const e=t.getItems()[0].getDomRef();if(e){e.focus()}this._currentTabKey="BasicInfo"},onTabSelect:function(t){let e=this.byId("iconTabBar").getSelectedKey();if(t){e=t}let o=this.byId("contractTypeSelect").getSelectedKey();if(!this.byId("contractTypeSelect").getSelectedKey()){this.byId("iconTabBar").setSelectedKey("BasicInfo");a.warning("Please select the Contract Type");return false}if(e!="BasicInfo"){if(this._SelectedContractType!=o){this.initializeDetails()}}if(e!="Details"){this._setDefaultFirstDetailsSectionTab()}this._SelectedContractType=o;return true},handleNextTabpress:function(t){if(this.onTabSelect(t)){this._oIconTabBar.setSelectedKey(t)}},_setDefaultFirstDetailsSectionTab:function(){var t=this.byId("idSpecificationBox");var e=this.getView().getModel("Details").getProperty("/AttributeGroups");if(e&&e.length>0){t.setSelectedKey(e[0].Attribute_Groups_ID)}},initializeDetails:function(){this.getBusyDialog().open();this.getBusyDialog().setText("...loading Basic Information.");const t=this.getOwnerComponent().getModel();let e=this.byId("contractTypeSelect").getSelectedKey();const a=this;const o=`/TemplatePortalCatalogue(TemplateID='${e}')`;const i=t.bindContext(o);const r=i.getBoundContext();this.productSpecificationBinding=t.bindList("Set",r,[],[],{$$ownRequest:true});this.model=t;this.isBound=true;return this.productSpecificationBinding.requestContexts(0,100).then(async function(t){const e=t.map(function(t){return t.getObject()});const o={};for(const t of e){const e=t.Attribute_Groups_ID||"defaultGroup";let i;if(!o[e]){o[e]={Attribute_Groups_ID:e,Attribute_Group_Name:t.Attribute_Group_Name||"Group",Attribute_Group_Role:t.Attribute_Group_Role||"",AttributeGroupOrder:t.AttributeGroupOrder||0,Attributes:[]}}let r=t.Attribute_Value||"";if(t.AttributeType.toLowerCase()==="date"){r=a._formateDateToDateValueFormat(r,t.AttributeType)}if(t.AttributeType==="select"){i=await a._getCombovalues(t.Attribute_ID);i=i.combovalues}if(a.contractId){if(a.contractData&&a.contractData.attribute_values){const e=a.contractData.attribute_values.find(e=>e.attribute_groups_ID===t.Attribute_Groups_ID&&e.attributes_ID===t.Attribute_ID);if(e){r=e.valueJson||""}if(t.AttributeType.toLowerCase()==="date"){r=a._formateDateToDateValueFormat(r,t.AttributeType)}}}const n={Attribute_ID:t.Attribute_ID,Attribute_Name:t.Attribute_Name,AttributeOrder:t.AttributeOrder||0,IsMandatory:!!t.Is_Required,AttributeType:t.AttributeType||"String",AttributeTypeAssociation:i||[],Value:r,IsPortalEnabled:typeof t.IsPortalEnabled!=="undefined"?t.IsPortalEnabled:null,Portal_ID:t.Portal_ID||null};o[e].Attributes.push(n)}let i=Object.keys(o).map(function(t){return o[t]});i.sort(function(t,e){return t.AttributeGroupOrder-e.AttributeGroupOrder});i.forEach(function(t){t.Attributes.sort(function(t,e){return t.AttributeOrder-e.AttributeOrder})});const r={AttributeGroups:i};a.getOwnerComponent().getModel("Details").setData(r);console.log("Details",a.getOwnerComponent().getModel("Details").getData());a.getBusyDialog().close();return r}).catch(function(t){jQuery.sap.log.error("Failed to load TemplatePortalCatalogue Set",t);throw t})},_formateDateToDateValueFormat:function(t,e){if(typeof t==="string"&&t.trim()!==""&&e&&e.toLowerCase()==="date"){const e=new Date(t);if(!isNaN(e.getTime())){t=e}else{console.warn("Invalid date format:",t);t=null}}else if(t===""){t=null}return t},onNavigation:function(t){var e=this.getOwnerComponent().getRouter();var t;if(t){e.navTo(t)}else{console.error("Navigation target not defined.")}},handleSaveContractDetails:function(){console.log(this.getView().getModel("Details").getData())},formatDate:function(t){if(!t){return""}try{var e=new Date(t);if(isNaN(e.getTime())){return t}var a=function(t){return t<10?"0"+t:t};return e.getFullYear()+"-"+a(e.getMonth()+1)+"-"+a(e.getDate())}catch(e){return t}},formatAttribute:function(t,e){if(t===null||typeof t==="undefined"||t===""){return""}if(e==="CheckBox"){if(t===true||t==="true"||t==="1"||t===1){return"Yes"}return"No"}if(e==="DatePicker"){return this.formatDate(t)}if(e==="MultiInput"){if(Array.isArray(t)){return t.join(", ")}return String(t)}return String(t)},onUploadCompleted:async function(t){let e=t.getParameters().item;let a=this.getModel("contractModel").getProperty("/attachments")||[];let o=Array.isArray(e)?e:[e];let i=this;const r=await Promise.all(o.map(async function(t){return await i._getfiledata(t)}));a.push(...r);this.getModel("contractModel").setProperty("/attachments",a);console.log("Mapped upload results:",a)},onBeforeUploadStarts:function(t){debugger},handleSaveandSubmitContractDetails:async function(t){const e=this.getModel("contractModel").getData();if(t==="save"){if(!this.validateControls(this.basicVaditionIds)){o.show("Please fill all mandatory fields.");return}}else{e.status="Submitted"}e.attribute_values=this.convertModelDataToAttributeValues();if(t==="save"){e.status="Draft"}else{e.status="Submitted"}let i=this;if(!this.contractId){try{const t=await this.ODataPost("/Contracts",e);if(t){o.show("Contract Submitted Successfully.");this.getRouter().navTo("Contracts")}}catch(t){console.error("Create failed:",t);o.show("Contract creation failed")}}else{console.log(this.getAppModulePathBaseURL());$.ajax({url:this.getAppModulePathBaseURL()+"/contracts/Contracts('"+this.contractId+"')",method:"PUT",contentType:"application/json",data:JSON.stringify(e),success:function(t){console.log(t);a.success("Contract Submitted Successfully.",{actions:[a.Action.OK],onClose:function(t){if(t===a.Action.OK){i.getRouter().navTo("Contracts")}}})},error:function(t){o.show("Error submitting data")}})}},convertModelDataToAttributeValues:function(){const t=this.getModel("Details").getData();const e=[];if(!t||!Array.isArray(t.AttributeGroups))return e;t.AttributeGroups.forEach(t=>{const a=t.Attribute_Groups_ID;(t.Attributes||[]).forEach(t=>{let o=typeof t.Value!=="undefined"&&t.Value!==null?t.Value:"";if(t.AttributeType==="boolean"){o=String(o)}let i=o;e.push({attribute_groups_ID:a,attributes_ID:t.Attribute_ID,valueJson:i})})});return e},validateControls:function(t){let e=true;t.forEach(t=>{const a=this.byId(t);if(!a){console.warn("Control not found:",t);return}let o=null;if(a.getValue){o=a.getValue()}else if(a.getSelectedKey){o=a.getSelectedKey()}else if(a.getDateValue){o=a.getDateValue()}else if(a.getSelected){o=a.getSelected()}if(typeof o==="string"){o=o.trim()}const i=o===null||o===""||o===undefined;if(i){e=false;a.setValueState("Error");a.setValueStateText("This field is required.")}else{a.setValueState("None")}});return e},clearValidationStates:function(t){t.forEach(t=>{const e=this.byId(t);if(!e)return;if(e.setValueState){e.setValueState("None");e.setValueStateText("")}})}})});
//# sourceMappingURL=ContractDetails.controller.js.map