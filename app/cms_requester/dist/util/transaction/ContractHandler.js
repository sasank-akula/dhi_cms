sap.ui.define(["sap/ui/base/Object"],function(t){"use strict";return t.extend("com.dhi.cms.cmsrequester.util.transaction.ContractHandler",{constructor:function(t){this.batchId="contracts";this.model=null;this.entityName="Contracts";this.associations={attribute_values:"attribute_values",attachments:"attachments",templates:"templates"};this.isBound=false;this.activeContext=null;this.mandatoryFields=[];this.attributeDataFetchedMap={}},initializeBinding:function(t,e){this.controller=e;this.model=t;this.contractBinding=this.model.bindList(`/${this.entityName}`,null,[],[],{$expand:"templates,attribute_values,attachments",$$updateGroupId:this.batchId});this.isBound=true},resetAttributeFetchState:function(){this.attributeDataFetchedMap={};this.attributeValues=null;this.resetContractAttributes=true},createNewContract:function(t){this.model.resetChanges(this.batchId);this.createContext=this.contractBinding.create(Object.assign({alias:"",contract_id:"",name:"",description:"",start_date:null,end_date:null,status:"Draft",templates_ID:null},t||{}),{$$updateGroupId:this.batchId});this.activeContext=this.createContext;this.attributeValues=this.model.bindList(`${this.associations.attribute_values}`,this.activeContext,[],[],{$$updateGroupId:this.batchId});this.assetBinding=this.model.bindList(`${this.associations.attachments}`,this.activeContext,[],[],{$$updateGroupId:this.batchId});return this.createContext},getExistingContract:function(t){return new Promise((e,i)=>{let s=this.getContractContext(t);if(!s){return i(new Error("Context not found"))}if(s.isTransient&&s.isTransient()){return i(new Error("Context is transient/unready"))}s.requestObject().then(()=>{this.activeContext=s;this._ensureAssociationBindings();e(s)}).catch(i)})},_ensureAssociationBindings:function(){if(!this.attributeValues||this.attributeValues.getContext()!==this.activeContext){this.attributeValues=this.model.bindList(`${this.associations.attribute_values}`,this.activeContext,[],[],{$$updateGroupId:this.batchId})}if(!this.assetBinding||this.assetBinding.getContext()!==this.activeContext){this.assetBinding=this.model.bindList(`${this.associations.attachments}`,this.activeContext,[],[],{$$updateGroupId:this.batchId})}},getContractContext:function(t){const e=`/Contracts(${t})`;const i=this.model.bindContext(e,{$$ownRequest:true});return i.getBoundContext()},getActiveContext:function(){this._ensureAssociationBindings();return this.activeContext},getContractAttributes:function(){this.getActiveContext();const t=this.activeContext.getProperty("ID");return new Promise((e,i)=>{if(this.attributeDataFetchedMap[t]&&!this.resetContractAttributes){const t=this.attributeValues.getContexts();e(t.map(t=>t.getObject()))}else{this.attributeValues.getContexts(0,200);this.attributeValues.attachEventOnce("dataReceived",()=>{const i=this.attributeValues.getContexts();this.attributeDataFetchedMap[t]=true;this.resetContractAttributes=false;e(i.map(t=>t.getObject()))})}})},createAttribute:function({attribute_groups_ID:t,attributes_ID:e,value:i}){this.getActiveContext();this.attributeValues.create({attribute_groups_ID:t,attributes_ID:e,valueJson:this._formattedJsonValue(i)})},updateAttribute:function(t,e){return new Promise((i,s)=>{const{ID:n,contracts_ID:a,attribute_groups_ID:r,attributes_ID:o}=t;const u=this.model.getKeyPredicate("/ContractsAttributes",{ID:n,contracts_ID:a,attribute_groups_ID:r,attributes_ID:o});const c=`/ContractsAttributes`+u;const h=this.model.bindContext(c,{$$ownRequest:true});const d=h.getBoundContext();d.requestObject().then(()=>{d.setProperty("valueJson",this._formattedJsonValue(e));i()}).catch(s)})},_formattedJsonValue:function(t){const e={value:t===null?"null":t};const i=JSON.stringify(e);return i.replace(/"/g,'\\"')},save:function(){return this.model.submitBatch(this.batchId)},deleteContract:function(t){return new Promise((e,i)=>{const s=this.getContractContext(t);s.requestObject().then(()=>{s.delete().then(e).catch(i)}).catch(i)})}})});
//# sourceMappingURL=ContractHandler.js.map