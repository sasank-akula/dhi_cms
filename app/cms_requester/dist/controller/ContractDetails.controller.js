sap.ui.define(["./BaseController","sap/ui/core/mvc/Controller","sap/m/MessageBox","sap/m/MessageToast","com/dhi/cms/cmsrequester/util/transaction/ContractManager","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/ui/core/BusyIndicator"],(t,e,a,o,i,r,n,s,l)=>{"use strict";return t.extend("com.dhi.cms.cmsrequester.controller.ContractDetails",{onInit(){this.getRouter().getRoute("ContractDetails").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(t){l.show(0);this.basicVaditionIds=["contractTitleInput","contractTypeSelect","contractaliasInput","contractdescriptionInput"];this.clearValidationStates(this.basicVaditionIds);if(this.getModel("Details").getProperty("/dynamicControlIds")){this.clearValidationStates(this.getModel("Details").getProperty("/dynamicControlIds"))}this._SelectedContractType;const e=t.getParameter("arguments");this.contractId=e.contractId;const a=t.getParameter("name");const o=!!this.contractId;this._oIconTabBar=this.byId("iconTabBar");if(!this.contractId){this._initializeContractMasters()}else{this._getContractDetails()}this._focusOnBasicInfoTab();l.hide()},_initializeContractMasters:function(){const t={ID:null,alias:null,contract_id:null,description:null,end_date:null,is_visible:true,name:null,start_date:null,templates_ID:null,attribute_values:[],attachments:[]};this.getModel("contractModel").setData(t)},_getContractDetails:async function(){let t=this.getModel();let e="/Contracts('"+this.contractId+"')";let a=t.bindContext(e,undefined,{$expand:"attribute_values,attachments"});let o=await a.requestObject().then(function(t){console.log(t);return t});this.contractData=o;this.getModel("contractModel").setData(o);this.getModel("appModel").setProperty("/status",o.status);if(o.status==="Draft"){this.getModel("appModel").setProperty("/isFieldEditable",true);this.getModel("appModel").setProperty("/attachmentsMode","Delete")}else if(o.status==="Submitted"){this.getModel("appModel").setProperty("/isFieldEditable",false);this.getModel("appModel").setProperty("/attachmentsMode","None")}},_focusOnBasicInfoTab:function(){const t=this.byId("iconTabBar");t.setSelectedKey("BasicInfo");const e=t.getItems()[0].getDomRef();if(e){e.focus()}this._currentTabKey="BasicInfo"},onTabSelect:async function(t){let e=this.byId("iconTabBar").getSelectedKey();if(t){e=t}let o=this.byId("contractTypeSelect").getSelectedKey();if(!this.byId("contractTypeSelect").getSelectedKey()){this.byId("iconTabBar").setSelectedKey("BasicInfo");a.warning("Please select the Contract Type");return false}if(e!="BasicInfo"){if(this._SelectedContractType!=o){this.getView().setBusy(true);await this.initializeDetails();this.getView().setBusy(false)}}if(e!="Details"){this._setDefaultFirstDetailsSectionTab()}if(e!="ContractPrev"){this._previewLayout()}this._SelectedContractType=o;return true},handleNextTabpress:function(t){if(this.onTabSelect(t)){this._oIconTabBar.setSelectedKey(t)}},_setDefaultFirstDetailsSectionTab:function(){var t=this.byId("idSpecificationBox");var e=this.getView().getModel("Details").getProperty("/AttributeGroups");if(e&&e.length>0){t.setSelectedKey(e[0].Attribute_Groups_ID)}},initializeDetails:function(){const t=this.getOwnerComponent().getModel();let e=this.byId("contractTypeSelect").getSelectedKey();const a=this;const o=`/TemplatePortalCatalogue(TemplateID='${e}')`;const i=t.bindContext(o);const r=i.getBoundContext();this.productSpecificationBinding=t.bindList("Set",r,[],[],{$$ownRequest:true});this.model=t;this.isBound=true;return this.productSpecificationBinding.requestContexts(0,100).then(async function(t){const e=t.map(function(t){return t.getObject()});const o={};for(const t of e){const e=t.Attribute_Groups_ID||"defaultGroup";let i;if(!o[e]){o[e]={Attribute_Groups_ID:e,Attribute_Group_Name:t.Attribute_Group_Name||"Group",Attribute_Group_Role:t.Attribute_Group_Role||"",AttributeGroupOrder:t.AttributeGroupOrder||0,Attributes:[]}}let r=t.Attribute_Value||"";if(t.AttributeType.toLowerCase()==="date"){r=a._formateDateToDateValueFormat(r,t.AttributeType)}if(t.AttributeType==="select"){i=await a._getCombovalues(t.Attribute_ID);i=i.combovalues}if(a.contractId){if(a.contractData&&a.contractData.attribute_values){const e=a.contractData.attribute_values.find(e=>e.attribute_groups_ID===t.Attribute_Groups_ID&&e.attributes_ID===t.Attribute_ID);if(e){r=e.valueJson||""}if(t.AttributeType.toLowerCase()==="date"){r=a._formateDateToDateValueFormat(r,t.AttributeType)}}}const n={Attribute_ID:t.Attribute_ID,Attribute_Name:t.Attribute_Name,AttributeOrder:t.AttributeOrder||0,IsMandatory:!!t.Is_Required,AttributeType:t.AttributeType||"String",AttributeTypeAssociation:i||[],Value:r,IsPortalEnabled:typeof t.IsPortalEnabled!=="undefined"?t.IsPortalEnabled:null,Portal_ID:t.Portal_ID||null};o[e].Attributes.push(n)}let i=Object.keys(o).map(function(t){return o[t]});i.sort(function(t,e){return t.AttributeGroupOrder-e.AttributeGroupOrder});i.forEach(function(t){t.Attributes.sort(function(t,e){return t.AttributeOrder-e.AttributeOrder})});const r={AttributeGroups:i};a.getOwnerComponent().getModel("Details").setData(r);console.log("Details",a.getOwnerComponent().getModel("Details").getData());return r}).catch(function(t){jQuery.sap.log.error("Failed to load TemplatePortalCatalogue Set",t);throw t})},_formateDateToDateValueFormat:function(t,e){if(typeof t==="string"&&t.trim()!==""&&e&&e.toLowerCase()==="date"){const e=new Date(t);if(!isNaN(e.getTime())){t=e}else{console.warn("Invalid date format:",t);t=null}}else if(t===""){t=null}return t},onNavigation:function(t){var e=this.getOwnerComponent().getRouter();var t;if(t){e.navTo(t)}else{console.error("Navigation target not defined.")}},handleSaveContractDetails:function(){console.log(this.getView().getModel("Details").getData())},formatDate:function(t){if(!t){return""}try{var e=new Date(t);if(isNaN(e.getTime())){return t}var a=function(t){return t<10?"0"+t:t};return e.getFullYear()+"-"+a(e.getMonth()+1)+"-"+a(e.getDate())}catch(e){return t}},formatAttribute:function(t,e){if(t===null||typeof t==="undefined"||t===""){return""}if(e==="CheckBox"){if(t===true||t==="true"||t==="1"||t===1){return"Yes"}return"No"}if(e==="DatePicker"){return this.formatDate(t)}if(e==="MultiInput"){if(Array.isArray(t)){return t.join(", ")}return String(t)}return String(t)},onUploadCompleted:async function(t){let e=t.getParameters().item;let o=this.getModel("contractModel").getProperty("/attachments")||[];let i=Array.isArray(e)?e:[e];let r=o.length+i.length;if(r>5){a.warning("Attachments limit is Exceeded.");return}let n=this;const s=await Promise.all(i.map(async function(t){return await n._getfiledata(t)}));o.push(...s);this.getModel("contractModel").setProperty("/attachments",o);console.log("Mapped upload results:",o)},onBeforeUploadStarts:function(t){debugger},onDeleteDocumentPress:function(t){var e=t.getParameter("listItem");if(!e){console.warn("Delete event fired without listItem");return}var a=this.getModel("contractModel");var o=e.getBindingContext("contractModel");if(o){var i=o.getPath();var r=i.split("/");var n=r.pop();var s=a.getProperty("/attachments")||[];var l=parseInt(n,10);if(!isNaN(l)&&l>=0&&l<s.length){sap.m.MessageBox.confirm("Are you sure you want to delete this attachment?",{onClose:function(t){if(t===sap.m.MessageBox.Action.OK){s.splice(l,1);a.setProperty("/attachments",s)}else{}}})}else{console.error("Invalid attachment index:",n,"path:",i)}}else{var u=e.getCells&&e.getCells()[0]&&e.getCells()[0].getText&&e.getCells()[0].getText();var s=a.getProperty("/attachments")||[];var c=s.findIndex(function(t){return t.file_name===u||t.file_url===u});if(c>=0){s.splice(c,1);a.setProperty("/attachments",s)}else{console.warn("Could not find matching attachment to delete (fallback).")}}},handleSaveandSubmitContractDetails:async function(t){const e=this.getModel("contractModel").getData();if(!this.validateControls(this.basicVaditionIds)){o.show("Please fill all mandatory fields.");return}e.status="Draft";if(t==="submit"){if(!this.validateControls(this.getModel("Details").getProperty("/dynamicControlIds"))){o.show("Please fill all mandatory fields.");return}e.status="Submitted"}e.attribute_values=this.convertModelDataToAttributeValues();let i=this;if(!this.contractId){try{const t=await this.ODataPost("/Contracts",e);if(t){a.success("Contract Submitted Successfully.",{actions:[a.Action.OK],onClose:function(t){if(t===a.Action.OK){i.getRouter().navTo("Contracts")}}})}}catch(t){console.error("Create failed:",t);o.show("Contract creation failed")}}else{console.log(this.getAppModulePathBaseURL());$.ajax({url:this.getAppModulePathBaseURL()+"/contracts/Contracts('"+this.contractId+"')",method:"PUT",contentType:"application/json",data:JSON.stringify(e),success:function(t){console.log(t);a.success("Contract Submitted Successfully.",{actions:[a.Action.OK],onClose:function(t){if(t===a.Action.OK){i.getRouter().navTo("Contracts")}}})},error:function(t){o.show("Error submitting data")}})}},convertModelDataToAttributeValues:function(){const t=this.getModel("Details").getData();const e=[];if(!t||!Array.isArray(t.AttributeGroups))return e;t.AttributeGroups.forEach(t=>{const a=t.Attribute_Groups_ID;(t.Attributes||[]).forEach(t=>{let o=typeof t.Value!=="undefined"&&t.Value!==null?t.Value:"";if(t.AttributeType==="boolean"){o=String(o)}let i=o;e.push({attribute_groups_ID:a,attributes_ID:t.Attribute_ID,valueJson:i})})});return e},validateControls:function(t){let e=true;t.forEach(t=>{let a=this.byId(t);if(!a){a=sap.ui.getCore().byId(t);if(!a){console.log("Control not found:",t);return}}let o=null;if(a.getValue){o=a.getValue()}else if(a.getSelectedKey){o=a.getSelectedKey()}else if(a.getDateValue){o=a.getDateValue()}else if(a.getSelected){o=a.getSelected()}if(typeof o==="string"){o=o.trim()}const i=o===null||o===""||o===undefined;if(i){e=false;a.setValueState("Error");a.setValueStateText("This field is required.")}else{a.setValueState("None")}});return e},clearValidationStates:function(t){t.forEach(t=>{let e=this.byId(t);if(!e){e=sap.ui.getCore().byId(t);if(!e){console.log("Control not found:",t);return}}if(e.setValueState){e.setValueState("None");e.setValueStateText("")}})},onControlValueChange:function(t){const e=t.getSource();let a=null;if(e.getValue){a=e.getValue()}else if(e.getSelectedKey){a=e.getSelectedKey()}else if(e.getDateValue){a=e.getDateValue()}else if(e.getSelected){a=e.getSelected()}if(a!==null&&a!==""&&a!==undefined){e.setValueState("None");e.setValueStateText("")}},_previewLayout:function(){const t=this.getView();const e=t.getModel("Details");const a=e.getProperty("/AttributeGroups");const o=t.byId("previewDialogVBox");o.removeAllItems();a.forEach(t=>{const e=new sap.m.Panel({headerText:t.Attribute_Group_Name,expandable:false,expanded:true,width:"98%"});const a=new sap.ui.layout.form.SimpleForm({editable:true,layout:"ColumnLayout"});t.Attributes.forEach(t=>{a.addContent(new sap.m.Label({text:t.Attribute_Name}));a.addContent(new sap.m.Text({text:this.formatAttribute(t.Value,t.AttributeType)}))});e.addContent(a);e.addStyleClass("groupPanelClass");o.addItem(e)})}})});
//# sourceMappingURL=ContractDetails.controller.js.map