sap.ui.define(["./BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/m/Token","../model/formatter"],function(e,t,a,s,n){"use strict";return e.extend("com.dhi.cms.cmsadmin.controller.CreateAttributes",{formatter:n,onCancel:function(){["attributeNameInput","AttributeTypeSelect","aliasNameAttrInput","descriptionInput","associationsSelect","attributeTypeInput","descriptionTextArea","attributeMaxLength","attributeMinLength"].forEach(function(e){var t=this.byId(e);if(t&&t.setValueState){t.setValueState("None");t.setValueStateText("")}}.bind(this));var e=this.byId("valuesGridTable");if(e&&e.getRows){var t=e.getRows();t.forEach(function(e){var t=e&&e.getAggregation&&e.getAggregation("cells")[0];if(t&&t.setValueState){t.setValueState("None");t.setValueStateText("")}})}this.onNavigation("Attributes")},onInit:function(){this.getRouter().getRoute("Create Attributes").attachPatternMatched(this._onObjectMatched,this)},onDeleteRow:function(e){debugger;const t=this.getView().getModel("appModel");const a=e.getSource().getBindingContext("appModel");const s=a.getPath().split("/").pop();const n=t.getProperty("/Attributes/combovalues/results");n.splice(s,1);t.setProperty("/Attributes/combovalues/results",n);var r=this.byId("valuesGridTable");if(r&&r.getRows){var i=r.getRows();i.forEach(function(e){var t=e&&e.getAggregation&&e.getAggregation("cells")[0];if(t&&t.setValueState){t.setValueState("None");t.setValueStateText("")}})}},onAddRow:function(){const e=this.getView().getModel("appModel");let t=e.getProperty("/Attributes/combovalues/results");if(!t){let a={results:[]};e.setProperty("/Attributes/combovalues",a);t=a.results}if(!Array.isArray(t)){t=[]}if(t.length>=100){sap.m.MessageBox.error("You cannot add more than 100 Combo Values.");return}t.push({value:""});e.setProperty("/Attributes/combovalues/results",t)},_onObjectMatched:function(e){var t=e.getParameter("name");this.attributeId=e.getParameter("arguments").attributeId;var a=!!this.attributeId;this.getModel("appModel").setProperty("/isEditMode",a);var s=a?this.getResourceBundle().getText("Update_Attribute_Title"):this.getResourceBundle().getText("Create_Attribute_Title");this.getView().byId("createAttributeTitle").setText(s);if(!this.attributeId){this.getModel("appModel").setProperty("/Attributes",{});this.getModel("appModel").setProperty("/Attributes/type","string")}else{this._fnReadAttributes(this.attributeId)}this._fnRegisterMessageManager()},_fnReadAttributes:function(e){debugger;var t=this;this.getModel("oDataV2").read("/Attributes("+e+")",{urlParameters:{$expand:"combovalues"},success:function(e,a){debugger;t.getModel("appModel").setProperty("/Attributes",e)},error:function(e){a.error(`${e.message}: ${e.statusCode} ${JSON.parse(e.responseText).error.message.value}`)}})},onSave:async function(){const e=this.getView().getModel("appModel");const t=e.getProperty("/Attributes");let s=true;const n=this.byId("attributeNameInput");const r=this.byId("AttributeTypeSelect");const i=this.byId("aliasNameAttrInput");const u=this.byId("descriptionInput");const l=this.byId("associationsSelect");const o=this.byId("attributeTypeInput");const g=(e,t,a,s,n,r,i)=>{if(!e||e.toString().trim()===""){t.setValueState("Error");t.setValueStateText(a);return false}if(r&&e.length<r){t.setValueState("Error");t.setValueStateText(i);return false}if(s&&e.length>s){t.setValueState("Error");t.setValueStateText(n);return false}t.setValueState("None");return true};const d=n.getMaxLength?n.getMaxLength():50;const c=n.getMinLength?n.getMinLength():0;s&=g(t.name,n,"Attribute Name is required.",d,`Attribute Name must be less than ${d} characters.`,c,c>0?`Attribute Name must be at least ${c} characters.`:undefined);s&=g(t.type,r,"Attribute Type is required.");const h=i.getMaxLength?i.getMaxLength():50;const f=i.getMinLength?i.getMinLength():0;s&=g(t.alias,i,"Alias Name is required.",h,`Alias Name must be less than ${h} characters.`,f,f>0?`Alias Name must be at least ${f} characters.`:undefined);const b=this.byId("descriptionTextArea");const m=b&&b.getMaxLength?b.getMaxLength():100;const p=b&&b.getMinLength?b.getMinLength():0;if(b&&t.desc){s&=g(t.desc,b,"",m,`Description must be less than ${m} characters.`,p,p>0?`Description must be at least ${p} characters.`:undefined)}else if(b){b.setValueState("None");b.setValueStateText("")}const v=this.byId("attributeMinLength");const S=this.byId("attributeMaxLength");let y=t.minlength!==undefined&&t.minlength!==null&&t.minlength!==""?parseFloat(t.minlength):undefined;let M=t.maxlength!==undefined&&t.maxlength!==null&&t.maxlength!==""?parseFloat(t.maxlength):undefined;let x=false,V=false;if(y!==undefined&&y<0){s=false;x=true;if(v){v.setValueState("Error");v.setValueStateText("Minimum value cannot be negative.")}}else if(v){v.setValueState("None");v.setValueStateText("")}if(M!==undefined&&M<0){s=false;V=true;if(S){S.setValueState("Error");S.setValueStateText("Maximum value cannot be negative.")}}else if(S){S.setValueState("None");S.setValueStateText("")}if(!x&&!V&&y!==undefined&&M!==undefined&&y>M){s=false;if(v){v.setValueState("Error");v.setValueStateText("Minimum value cannot be greater than maximum value.")}if(S){S.setValueState("Error");S.setValueStateText("Maximum value cannot be less than minimum value.")}}if(t.type==="number"&&o&&t.value){const e=t.minlength!==undefined&&t.minlength!==null&&t.minlength!==""?parseFloat(t.minlength):undefined;const a=t.maxlength!==undefined&&t.maxlength!==null&&t.maxlength!==""?parseFloat(t.maxlength):undefined;const n=parseFloat(t.value);if(a!==undefined&&n>a){s=false;o.setValueState("Error");o.setValueStateText("Value must be less than or equal to Max Length.")}else if(e!==undefined&&n<e){s=false;o.setValueState("Error");o.setValueStateText("Value must be greater than or equal to Min Length.")}else{o.setValueState("None");o.setValueStateText("")}}if(t.type==="string"&&o&&t.value){const e=t.minlength!==undefined&&t.minlength!==null&&t.minlength!==""?parseInt(t.minlength):undefined;const a=t.maxlength!==undefined&&t.maxlength!==null&&t.maxlength!==""?parseInt(t.maxlength):undefined;if(a!==undefined&&t.value.length>a){s=false;o.setValueState("Error");o.setValueStateText("String length must be less than or equal to Max Length.")}else if(e!==undefined&&t.value.length<e){s=false;o.setValueState("Error");o.setValueStateText("String length must be greater than or equal to Min Length.")}else{o.setValueState("None");o.setValueStateText("")}}const A=t.combovalues&&t.combovalues.results||[];if(Array.isArray(A)){if(A.length>100){a.error("You cannot have more than 100 Combo Values.");return}var T=this.byId("valuesGridTable");if(T&&T.getRows){var I=T.getRows();A.forEach((e,t)=>{var a=I[t];var n=a&&a.getAggregation&&a.getAggregation("cells")[0];if(!e.value||e.value.toString().trim()===""){s=false;if(n&&n.setValueState){n.setValueState("Error");n.setValueStateText("Value is required.")}}else{if(n&&n.setValueState){n.setValueState("None");n.setValueStateText("")}}});if(t.type==="select"&&A.length===0){s=false;a.error("At least one Select value is required for type 'select'.")}}}if(!s)return;var N=this.getView();N.setBusyIndicatorDelay(0);N.setBusy(true);try{await this.handleSaveAttribute()}catch(e){N.setBusy(false);console.error("Save failed:",e)}},attributeTypeChange:function(e){debugger;var t=e.getParameter("selectedItem").getKey();var a=this.byId("associationsSelect");var s=this.byId("attributeTypeInput");a.setValue("");if(t=="number"||t=="integer")s.setType("Number");else s.setType("Text");if(t=="boolean"||t=="select"||t=="date"){this.getModel("appModel").setProperty("/Attributes/maxlength",null);this.getModel("appModel").setProperty("/Attributes/minlength",null)}},resetValueStates:function(e){if(e.getSource().getText("text")!=="Save"){this.onNavigation("Attributes")}this.byId("attributeNameInput").setValueState("None");this.byId("AttributeTypeSelect").setValueState("None");this.byId("aliasNameAttrInput").setValueState("None")},handleSaveAttribute:function(e){var t=this;var s=this.getView();var n=this.getResourceBundle();var r=this.getModel();var i=this.getModel("appModel").getData().Attributes;var u={ID:i.ID,name:i.name,desc:i.desc,alias:i.alias,type:i.type,value:i.type==="select"?this.byId("associationsSelect").getSelectedKey():i.value,status:i.status,is_mandatory:this.byId("isMandatorySwitch").getState(),minlength:i.minlength,maxlength:i.maxlength,combovalues:i.type==="select"?i.combovalues&&i.combovalues.results?i.combovalues.results:[]:[]};debugger;if(i.ID===undefined){var l=r.bindList("/Attributes",undefined,undefined,undefined,undefined);r.resetChanges("$auto",true);this.oContext=l.create(u,{bSkipRefresh:true});this._refreshMessageManager();this.getModel().submitBatch("$auto").then(function(e){var r=t.getModel("message").getData();var i=r.slice().reverse().find(e=>e.type==="Error");if(i){debugger;let e="";try{e=i.message}catch(t){e="An unexpected error occurred."}if(e&&e.toLowerCase().startsWith("unique constraint violated")){a.error("Enter Unique Attribute name")}else{a.error(`Error: ${e}`)}t._refreshMessageManager();s.setBusy(false);return}else{debugger;var u=t.getModel().bindContext(`/Attributes`,undefined,undefined,undefined,undefined);u.requestObject().then(e=>{console.log(e);var r=t.getModel("appModel").getData().Attributes;var i=e.value.filter(e=>e.name==r.name);console.log(i);a.success(n.getText("attributeSaveSuccess"),{actions:[a.Action.OK],onClose:function(e){if(e===a.Action.OK){t.onNavigation("Attributes")}}});t._fnReadAttributes(i[0].ID);t._refreshMessageManager();s.setBusy(false)})}})}else{this._refreshMessageManager();this.getModel("oDataV2").update("/Attributes(guid'"+i.ID+"')",u,{success:function(e,r){a.success(n.getText("attributeUpdateSuccess"),{actions:[a.Action.OK],onClose:function(e){if(e===a.Action.OK){t.onNavigation("Attributes")}}});s.setBusy(false)},error:function(e){let t="";try{t=JSON.parse(e.responseText).error.message.value}catch(a){t=e.message}if(t&&t.toLowerCase().startsWith("unique constraint violated")){a.error("Enter Unique Attribute name")}else{a.error(`${e.message}: ${e.statusCode} ${t}`)}s.setBusy(false)}})}}})});
//# sourceMappingURL=CreateAttributes.controller.js.map