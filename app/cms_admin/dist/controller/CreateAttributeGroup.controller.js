sap.ui.define(["./BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/ui/model/Filter","sap/ui/model/FilterOperator","../model/formatter"],function(t,e,r,a,o,jquery,s,i,n){"use strict";return t.extend("com.dhi.cms.cmsadmin.controller.CreateAttributeGroup",{formatter:n,onInit:function(){this.getRouter().getRoute("Create Attribute Group").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(t){var e=t.getParameter("name");var r=t.getParameter("arguments");var a=r.attributeGroupId;var o=!!a;this.getModel("appModel").setProperty("/isEditMode",o);this.attributeGroupId=a;this._fnRegisterMessageManager();var s=o?this.getResourceBundle().getText("Update_Attribute_Group_Title"):this.getResourceBundle().getText("Create_Attribute_Group_Title");this.getView().byId("attributeGroupTitle").setText(s);debugger;if(a){this._fnReadExistingAttributeGroup(a)}else{this._fnReadAttributes();this.getModel("appModel").setProperty("/AttributeGroup",[]);this.getModel("appModel").setProperty("/AssociatedAttributes",[])}this._fnRegisterMessageManager()},mergeAttributes:function(t,e){const r=new Map(t.map(t=>[t.name,t]));e.forEach(e=>{if(!r.has(e.name)){t.push({...e})}else{const t=r.get(e.name);Object.assign(t,e)}});return t},_fnReadAttributes:function(){var t=this;debugger;this.getModel("oDataV2").read("/Attributes",{success:function(e,r){var a=e.results;var o=t.getModel("appModel").getProperty("/AssociatedAttributes")||[];const s=new Map(o.map(t=>[t.name,t]));a.forEach(function(t){if(!s.has(t.name)){t.Rank=0}});var i=t.mergeAttributes(o,a);console.log("Merged Attributes:",i);t.getModel("appModel").setProperty("/AssociatedAttributes",i)},error:function(t){console.error("Error reading Attributes:",t)}})},onSave:function(){var t=true;var e=this.byId("attributeGrpNameInput").getValue();var r=this.byId("aliasNameInputAtrGrp").getValue();if(e===""){this.byId("attributeGrpNameInput").setValueState("Error");this.byId("attributeGrpNameInput").setValueStateText("This field is required.");t=false}else{this.byId("attributeGrpNameInput").setValueState("None")}if(t===true){this.handleSaveAttributeGroup();this.onNavigation("Attribute Groups");this.byId("attributeGrpNameInput").setValueState("None")}},handleSaveAttributeGroup:function(){let t=this.getResourceBundle();var e=this;var a=this.getModel("appModel").getData().AttributeGroup;var o=this.getModel("appModel").getData().AssociatedAttributes;var s={name:a.name,alias:a.alias,desc:a.desc,attributes:[]};for(var i=0;i<o.length;i++){var n=o[i];if(n.Rank>0){var u={sortID:n.Rank};if(n.attribute&&n.attribute.ID){u.attribute_ID=n.attribute.ID}else{u.attribute_ID=n.ID}s.attributes.push(u)}}if(a.ID===undefined){var d=this.getModel().bindList("/Attribute_Groups",undefined,undefined,undefined,undefined);this.oContext=d.create(s,{bSkipRefresh:true});this._refreshMessageManager();this.getModel().submitBatch("$auto").then(function(a){var o=e.getModel("message").getData();var s=o.slice().reverse().find(t=>t.type==="Error");if(s){s&&r.error(s.message);e._refreshMessageManager();return}else{var i=e.oContext.getPath();var n=e.extractIdFromPath(i);e._refreshMessageManager();r.success(t.getText("attributeGroupSaveSuccess"));debugger;setTimeout(function(){e._fnReadExistingAttributeGroup(n).then(function(t){e.getModel("appModel").setProperty("/AttributeGroup/attribute_group_id",t.attribute_group_id)})},1e3)}})}else{this.getModel("oDataV2").read("/Attribute_Groups("+a.ID+")?$expand=attributes($select=ID,sortID;",{success:function(o){console.log("Existing data for Attribute Group ID:",a.ID,o);e.getModel("oDataV2").update("/Attribute_Groups("+a.ID+")?$expand=attributes($select=ID,sortID)",s,{success:function(e,a){r.success(t.getText("attributeGroupUpdateSuccess"))},error:function(t){r.error(`${t.message}: ${t.statusCode} ${JSON.parse(t.responseText).error.message.value}`)}})},error:function(e){r.error(t.getText("attributeGroupReadError"))}})}},extractIdFromPath:function(t){var e=t.match(/\(([^)]+)\)/);return e?e[1]:null},onAddAttributes:function(){debugger;var t=this;var e=this.getView();if(!this._pDialog){this._pDialog=a.load({id:e.getId(),name:"com.dhi.cms.cmsadmin.fragments.attributegroups.AddAttributes",controller:this}).then(function(t){e.addDependent(t);return t})}var r=this.getModel("appModel");var o=r.getProperty("/AssociatedAttributes")||[];this._iRankCounter=o.length?Math.max(...o.map(t=>t.Rank))+1:1;console.log("Rank counter initialized to:",this._iRankCounter);var s=o.some(t=>t.sortID!==undefined);if(s){t._fnReadAttributes()}this._pDialog.then(function(t){t.open()})},onSearchAttributes:function(t){var e=t.getParameter("value");var r=new s("name",i.Contains,e);var a=t.getParameter("itemsBinding");a.filter([r])},onDeleteAttribute:function(t){var e=t.getSource();var r=e.getBindingContext("appModel").getPath();console.log("Modifying item at path:",r);var a=this.getModel("appModel");var o=a.getProperty("/AssociatedAttributes");console.log("Current data:",o);var s=parseInt(r.split("/").pop(),10);console.log("Index to modify:",s);if(o[s].sortID!==undefined){o.splice(s,1)}else{o[s].Rank=0}console.log("Data after setting rank to 0 or removing:",o);var i=o.filter(function(t){return t.Rank>0});i.forEach(function(t,e){t.Rank=e+1;if(t.sortID!==undefined){t.sortID=e+1}});o.forEach(function(t){if(t.Rank===0){var e=i.find(e=>e.ID===t.ID);if(!e){i.push(t)}}});a.setProperty("/AssociatedAttributes",i);console.log("Data after re-ranking:",i);var n=this.byId("attributesTitle");var u=i.filter(function(t){return t.Rank>0}).length;n.setText("Attributes ("+u+")");a.refresh()},onDialogClose:function(t){let r=this.getResourceBundle();var a=t.getParameter("selectedContexts");console.log("Dialog closed, selected contexts:",a);if(a&&a.length){var o=[];var s=this.getModel("appModel");console.log(s);var i=s.getProperty("/AssociatedAttributes")||[];var n=new Map(i.map(t=>[t.name,t]));a.forEach(function(t){var e=t.getObject();console.log("Selected Object:",e);if(n.has(e.name)&&n.get(e.name).Rank>0){console.log("Attribute already exists with Rank > 0, not updating Rank:",e.name)}else{console.log("Current Rank Counter:",this._iRankCounter);e.Rank=this._iRankCounter++;console.log("Updated Rank:",e.Rank);var r=i.some(t=>t.sortID!==undefined);if(r){e.sortID=e.Rank}console.log("Updated sortID:",e.sortID);console.log("New Rank Counter:",this._iRankCounter);o.push(e.name);if(!n.has(e.name)){i.push(e)}}}.bind(this));var u=o.length;console.log("total count of selected items",u);s.setProperty("/AssociatedAttributes",i);s.refresh();console.log("App model refreshed with updated ranks and added attributes.",s);var d=i.filter(function(t){return t.Rank>0}).length;var l=this.byId("tblAssociatedAttributes");var c=l.getHeaderToolbar().getContent()[0];c.setText("Attributes ("+d+")")}else{e.show(r.getText("attributeGroupNoNewItemSelected"))}var g=t.getSource();console.log("Event Source:",g);var p=g.getBinding("items");console.log("Items Binding before clearing filters:",p);if(p){p.filter([]);console.log("Filters cleared from items binding.")}else{console.error("Items binding not found.")}},onDropSelected:function(t){var e=this;var r=t.getParameter("draggedControl");var a=t.getParameter("droppedControl");var o=t.getParameter("dropPosition");var s=this.byId("tblAssociatedAttributes");var i=this.getView().getModel("appModel");var n=i.getProperty("/AssociatedAttributes");var u=n.filter(function(t){return t.Rank>0});var d=s.indexOfItem(r);var l=s.indexOfItem(a);if(o==="After"){l++}var c=u.splice(d,1)[0];u.splice(l,0,c);for(var g=0;g<u.length;g++){u[g].Rank=g+1;if(u[g].sortID!==undefined){u[g].sortID=u[g].Rank}}n.forEach(function(t){var e=u.find(function(e){return e.ID===t.ID});if(e){t.Rank=e.Rank;if(e.sortID!==undefined){t.sortID=e.Rank}}});i.setProperty("/AssociatedAttributes",u);console.log(n)},_fnReadExistingAttributeGroup:function(t){debugger;var e=this;var r="/Attribute_Groups("+t+")";var a={$expand:"templates($select=ID,sortID;$expand=templates($select=ID,name,desc)),attributes($select=ID,attribute,sortID;$expand=attribute($select=ID,attribute_id,name,desc))"};var o=this.getModel().bindContext(r,null,a);o.requestObject().then(function(t){if(Array.isArray(t.attributes)){t.attributes.forEach(function(t){t.Rank=t.sortID||0;if(t.attribute){t.name=t.attribute.name||"";t.desc=t.attribute.desc||""}else{t.name="";t.desc=""}});e.getModel("appModel").setProperty("/AttributeGroup",t);e.getModel("appModel").setProperty("/AssociatedAttributes",t.attributes)}console.log("Updated AttributeGroup data:",e.getModel("appModel").getProperty("/AttributeGroup"));console.log("Updated AssociatedAttributes data:",e.getModel("appModel").getProperty("/AssociatedAttributes"))})}})});
//# sourceMappingURL=CreateAttributeGroup.controller.js.map