sap.ui.define(["./BaseController","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,r,a,s,n){"use strict";return e.extend("com.dhi.cms.cmsadmin.controller.CreateTemplate",{onInit:function(){this.getRouter().getRoute("Create Template").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){var t=e.getParameter("name");var r=e.getParameter("arguments");var a=r.templateId;if(a){this._fnReadExistingTemplate(a)}else{this._fnReadAttributeGroup();this.getModel("appModel").setProperty("/Template",[]);this.getModel("appModel").setProperty("/AttributeGroups",[])}var s=!!a;this.getModel("appModel").setProperty("/isEditMode",s);this.templateId=a;this._fnRegisterMessageManager();var n=s?this.getResourceBundle().getText("Update_Template_Title"):this.getResourceBundle().getText("Create_Template_Title");this.getView().byId("createTemplateTitle").setText(n);this.templateRankLogic()},templateRankLogic:function(){this.getModel("appModel").refresh(true);var e=this.byId("tblAttrGrpTemplate2");var t=new sap.ui.model.Filter("Rank",sap.ui.model.FilterOperator.GT,0);var r={path:"appModel>/AttributeGroups",parameters:{arrayNames:["attributes"]},filters:[t]};e.bindRows(r)},mergeAttributeGroups:function(e,t){const r=new Map(e.map(e=>[e.name,e]));t.forEach(t=>{if(!r.has(t.name)){e.push({...t})}else{const e=r.get(t.name);Object.assign(e,t)}});return e},_fnReadAttributeGroup:function(){var e=this;var t=this.getModel();return new Promise(function(r,a){t.bindList("/Attribute_Groups",undefined,undefined,undefined,{$$updateGroupId:"readAttributeGroups",$expand:"attributes($expand=attribute)"}).requestContexts().then(function(t){var a=t.map(e=>e.getObject());a.forEach(e=>{e.attributes?.forEach(e=>{if(e.attribute){e.name=e.attribute.name||null;e.desc=e.attribute.desc||null}})});var s=e.getModel("appModel").getProperty("/AttributeGroups")||[];const n=new Map(s.map(e=>[e.name,e]));var i=a.filter(e=>{if(!n.has(e.name)){e.Rank=0;return true}return false});e.getModel("appModel").setProperty("/FilteredAttributeGroups",i);r()}).catch(function(e){console.error("Error reading Attribute Groups (V4):",e);a(e)})})},_fnReadExistingTemplate:function(e){debugger;var t=this;var r="/Templates("+e+")";var a={$expand:"attribute_groups($select=ID,sortID;$expand=attribute_groups($select=ID,attribute_group_id,name,desc;$expand=attributes($select=sortID;$expand=attribute)))"};var s=this.getModel().bindContext(r,null,a);s.requestObject().then(function(e){if(Array.isArray(e.attribute_groups)){e.attribute_groups.forEach(function(e){e.Rank=e.sortID||0;if(e.attribute_groups){e.name=e.attribute_groups.name||"";e.desc=e.attribute_groups.desc||"";if(Array.isArray(e.attribute_groups.attributes)){e.attributes=e.attribute_groups.attributes.map(function(e){var t=e.attribute||{};t.sortID=e.sortID;return t});e.attributes.sort(function(e,t){return(e.sortID||0)-(t.sortID||0)})}else{e.attributes=[]}}else{e.name="";e.desc="";e.attributes=[]}});t.getModel("appModel").setProperty("/Template",e);t.getModel("appModel").setProperty("/AttributeGroups",e.attribute_groups)}})},onAddAttributeGroup:function(){var e=this;var r=this.getView();r.setBusyIndicatorDelay(0);r.setBusy(true);if(!this._pDialog){this._pDialog=t.load({id:r.getId(),name:"com.dhi.cms.cmsadmin.fragments.templates.AddAttributeGroup",controller:this}).then(function(e){r.addDependent(e);return e})}this._fnReadAttributeGroup().then(function(){var t=e.getModel("appModel");var a=t.getProperty("/AttributeGroups")||[];e._iRankCounter=a.length?Math.max(...a.map(e=>e.Rank))+1:1;var s=a.some(e=>e.sortID!==undefined);e._pDialog.then(function(e){e.clearSelection();e.open();r.setBusy(false)})}).catch(function(){r.setBusy(false)})},onDropSelected:function(e){var t=this;var r=e.getParameter("draggedControl");var a=e.getParameter("droppedControl");var s=e.getParameter("dropPosition");var n=this.byId("tblAttrGrpTemplate");var i=this.getView().getModel("appModel");var o=i.getProperty("/AttributeGroups");var u=o.filter(function(e){return e.Rank>0});var l=n.indexOfItem(r);var p=n.indexOfItem(a);if(s==="After"){p++}var d=u.splice(l,1)[0];u.splice(p,0,d);for(var g=0;g<u.length;g++){u[g].Rank=g+1;if(u[g].sortID!==undefined){u[g].sortID=u[g].Rank}}o.forEach(function(e){var t=u.find(function(t){return t.ID===e.ID});if(t){e.Rank=t.Rank;if(t.sortID!==undefined){e.sortID=t.Rank}}});i.setProperty("/AttributeGroups",u)},onSave:async function(){var e=true;var t=this.byId("templateNameInput");var r=this.byId("templateDescInput");var a=t.getValue();var s=r.getValue();const n=t.getMaxLength?t.getMaxLength():50;if(!a||a.trim()===""){t.setValueState("Error");t.setValueStateText("This field is required.");e=false}else if(a.length>n){t.setValueState("Error");t.setValueStateText(`Name must be less than ${n} characters.`);e=false}else{t.setValueState("None")}const i=r.getMaxLength?r.getMaxLength():100;if(s&&s.length>i){r.setValueState("Error");r.setValueStateText(`Description must be less than ${i} characters.`);e=false}else{r.setValueState("None")}if(e===true){var o=this.getView();o.setBusyIndicatorDelay(0);o.setBusy(true);try{await this.handleSaveTemplate()}catch(e){console.error("Save failed:",e);o.setBusy(false)}this.byId("templateNameInput").setValueState("None");this.byId("templateDescInput").setValueState("None")}},onSearch:function(e){var t=e.getParameter("value");var s=new r("name",a.Contains,t);var n=e.getParameter("itemsBinding");n.filter([s])},handleSaveTemplate:function(){var e=this;let t=this.getResourceBundle();var r=this.getModel("appModel").getData().Template;var a=this.getModel("appModel").getData().AttributeGroups;var s={name:r.name,desc:r.desc,attribute_groups:[]};for(var i=0;i<a.length;i++){var o=a[i];if(o.Rank>0){var u={sortID:o.Rank};if(o.attribute_groups_ID){u.attribute_groups_ID=o.attribute_groups_ID}else{u.attribute_groups_ID=o.ID}s.attribute_groups.push(u)}}if(s.attribute_groups.length===0){n.error(t.getText("templateNoAttributeGroupError"));throw new Error("No attribute groups associated with the template.")}if(r.ID===undefined){var l=this.getView();this.getModel().resetChanges("$auto",true);var p=this.getModel().bindList("/Templates",undefined,undefined,undefined,undefined);this.getModel().resetChanges();this.oContext=p.create(s,{bSkipRefresh:true});this._refreshMessageManager();this.getModel().submitBatch("$auto").then(function(r){var a=e.getModel("message").getData();var s=a.slice().reverse().find(e=>e.type==="Error");if(s){let t="";try{t=s.message}catch(e){t="An unexpected error occurred."}if(t&&t.toLowerCase().startsWith("unique constraint violated")){n.error("Enter Unique Template name")}else{n.error(`Error: ${t}`)}e._refreshMessageManager();l.setBusy(false);return}else{var i=e.oContext.getPath();var o=e.extractIdFromPath(i);e._refreshMessageManager();setTimeout(function(){e._fnReadExistingTemplate(o).then(function(t){e.getModel("appModel").setProperty("/Template/template_id",t.template_id)})},1e3);n.success(t.getText("templateSaved"),{actions:[n.Action.OK],onClose:function(t){if(t===n.Action.OK){e.onNavigation("Templates")}}});l.setBusy(false)}})}else{var l=this.getView();this.getModel("oDataV2").read("/Templates("+r.ID+")?$expand=attribute_groups($select=ID,sortID)",{success:function(a){e.getModel("oDataV2").update("/Templates("+r.ID+")?$expand=attribute_groups($select=ID,sortID)",s,{success:function(r,a){n.success(t.getText("templateUpdated"),{actions:[n.Action.OK],onClose:function(t){if(t===n.Action.OK){e.onNavigation("Templates")}}});l.setBusy(false)},error:function(e){let t="";try{t=JSON.parse(e.responseText).error.message.value}catch(r){t=e.message||"An unexpected error occurred."}if(t&&t.toLowerCase().startsWith("unique constraint violated")){n.error("Enter Unique Template name")}else{n.error(`Error: ${t}`)}l.setBusy(false)}})},error:function(e){n.error(t.getText("templateReadError"));l.setBusy(false)}})}},extractIdFromPath:function(e){var t=e.match(/\(([^)]+)\)/);return t?t[1]:null},onDialogClose:function(e){debugger;let t=this.getResourceBundle();var r=e.getParameter("selectedContexts");if(r&&r.length){var a=[];var n=this.getModel("appModel");var i=n.getProperty("/AttributeGroups")||[];var o=new Map(i.map(e=>[e.name,e]));r.forEach(function(e){var t=e.getObject();if(o.has(t.name)&&o.get(t.name).Rank>0){}else{t.Rank=this._iRankCounter++;a.push(t.name);if(!o.has(t.name)){i.push(t)}}}.bind(this));var u=a.length;n.setProperty("/AttributeGroups",i);n.refresh();var i=n.getProperty("/AttributeGroups");var l=i.filter(function(e){return e.Rank>0}).length}else{s.show(t.getText("templateNoNewItemSelected"))}var p=e.getSource();var d=p.getBinding("items");if(d){d.filter([])}else{console.error("Items binding not found.")}},onDeleteAttributeGroup:function(e){debugger;var t=e.getSource();var r=t.getBindingContext("appModel").getPath();var a=this.getModel("appModel");var s=a.getProperty("/AttributeGroups");var n=parseInt(r.split("/").pop(),10);s.splice(n,1);s.forEach(function(e,t){e.Rank=t+1;if(e.sortID!==undefined){e.sortID=t+1}});a.setProperty("/AttributeGroups",s);a.refresh()}})});
//# sourceMappingURL=CreateTemplate.controller.js.map