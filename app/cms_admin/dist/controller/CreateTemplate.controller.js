sap.ui.define(["./BaseController","sap/ui/core/Fragment","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,r,a,s,i){"use strict";return e.extend("com.dhi.cms.cmsadmin.controller.CreateTemplate",{onInit:function(){this.getRouter().getRoute("Create Template").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){var t=e.getParameter("name");var r=e.getParameter("arguments");var a=r.templateId;var s=!!a;this.getModel("appModel").setProperty("/isEditMode",s);this._updateBreadcrumbs(t);this.templateId=a;this._fnRegisterMessageManager();var i=s?this.getResourceBundle().getText("Update_Template_Title"):this.getResourceBundle().getText("Create_Template_Title");this.getView().byId("createTemplateTitle").setText(i);this.templateRankLogic();if(a){this._fnReadExistingTemplate(a)}else{this._fnReadAttributeGroup();this.getModel("appModel").setProperty("/Template",[]);this.getModel("appModel").setProperty("/AttributeGroups",[])}},templateRankLogic:function(){this.getModel("appModel").refresh(true);var e=this.byId("tblAttrGrpTemplate2");var t=new sap.ui.model.Filter("Rank",sap.ui.model.FilterOperator.GT,0);var r={path:"appModel>/AttributeGroups",parameters:{arrayNames:["attributes"]},filters:[t]};e.bindRows(r)},mergeAttributeGroups:function(e,t){const r=new Map(e.map(e=>[e.name,e]));t.forEach(t=>{if(!r.has(t.name)){e.push({...t})}else{const e=r.get(t.name);Object.assign(e,t)}});return e},_fnReadAttributeGroup:function(){var e=this;var t=this.getModel();t.bindList("/Attribute_Groups",undefined,undefined,undefined,{$$updateGroupId:"readAttributeGroups",$expand:"attributes($expand=attribute)"}).requestContexts().then(function(t){var r=t.map(e=>e.getObject());r.forEach(e=>{e.attributes?.forEach(e=>{if(e.attribute){e.name=e.attribute.name||null;e.desc=e.attribute.desc||null}})});var a=e.getModel("appModel").getProperty("/AttributeGroups")||[];const s=new Map(a.map(e=>[e.name,e]));var i=r.filter(e=>{if(!s.has(e.name)){e.Rank=0;return true}return false});e.getModel("appModel").setProperty("/FilteredAttributeGroups",i)}).catch(function(e){console.error("Error reading Attribute Groups (V4):",e)})},_fnReadExistingTemplate:function(e){var t=this;var r="/Templates("+e+")";var a={$expand:"attribute_groups($select=ID,sortID;$expand=attribute_groups($select=ID,attribute_group_id,name,desc;$expand=attributes($select=sortID;$expand=attribute)))"};var s=this.getModel().bindContext(r,null,a);s.requestObject().then(function(e){if(Array.isArray(e.attribute_groups)){e.attribute_groups.forEach(function(e){e.Rank=e.sortID||0;if(e.attribute_groups){e.name=e.attribute_groups.name||"";e.desc=e.attribute_groups.desc||"";if(Array.isArray(e.attribute_groups.attributes)){e.attributes=e.attribute_groups.attributes.map(function(e){var t=e.attribute||{};t.sortID=e.sortID;return t});e.attributes.sort(function(e,t){return(e.sortID||0)-(t.sortID||0)})}else{e.attributes=[]}}else{e.name="";e.desc="";e.attributes=[]}});t.getModel("appModel").setProperty("/Template",e);t.getModel("appModel").setProperty("/AttributeGroups",e.attribute_groups)}})},onAddAttributeGroup:function(){var e=this;var r=this.getView();if(!this._pDialog){this._pDialog=t.load({id:r.getId(),name:"com.dhi.cms.cmsadmin.fragments.templates.AddAttributeGroup",controller:this}).then(function(e){r.addDependent(e);return e})}var a=this.getModel("appModel");var s=a.getProperty("/AttributeGroups")||[];this._iRankCounter=s.length?Math.max(...s.map(e=>e.Rank))+1:1;var i=s.some(e=>e.sortID!==undefined);if(i){e._fnReadAttributeGroup()}this._pDialog.then(function(e){e.open()})},onDropSelected:function(e){var t=this;var r=e.getParameter("draggedControl");var a=e.getParameter("droppedControl");var s=e.getParameter("dropPosition");var i=this.byId("tblAttrGrpTemplate");var n=this.getView().getModel("appModel");var o=n.getProperty("/AttributeGroups");var u=o.filter(function(e){return e.Rank>0});var p=i.indexOfItem(r);var l=i.indexOfItem(a);if(s==="After"){l++}var d=u.splice(p,1)[0];u.splice(l,0,d);for(var g=0;g<u.length;g++){u[g].Rank=g+1;if(u[g].sortID!==undefined){u[g].sortID=u[g].Rank}}o.forEach(function(e){var t=u.find(function(t){return t.ID===e.ID});if(t){e.Rank=t.Rank;if(t.sortID!==undefined){e.sortID=t.Rank}}});n.setProperty("/AttributeGroups",u)},onSave:function(){var e=true;var t=this.byId("templateNameInput").getValue();var r=this.byId("templateDescInput").getValue();if(t===""){this.byId("templateNameInput").setValueState("Error");this.byId("templateNameInput").setValueStateText("This field is required.");e=false}else{this.byId("templateNameInput").setValueState("None")}if(e===true){this.handleSaveTemplate();this.byId("templateNameInput").setValueState("None");this.byId("templateDescInput").setValueState("None");this.onNavigation("Templates")}},onSearch:function(e){var t=e.getParameter("value");var s=new r("name",a.Contains,t);var i=e.getParameter("itemsBinding");i.filter([s])},handleSaveTemplate:function(){var e=this;let t=this.getResourceBundle();var r=this.getModel("appModel").getData().Template;var a=this.getModel("appModel").getData().AttributeGroups;var s={name:r.name,desc:r.desc,attribute_groups:[]};for(var n=0;n<a.length;n++){var o=a[n];if(o.Rank>0){var u={sortID:o.Rank};if(o.attribute_groups_ID){u.attribute_groups_ID=o.attribute_groups_ID}else{u.attribute_groups_ID=o.ID}s.attribute_groups.push(u)}}if(r.ID===undefined){var p=this.getModel().bindList("/Templates",undefined,undefined,undefined,undefined);this.getModel().resetChanges();this.oContext=p.create(s,{bSkipRefresh:true});this._refreshMessageManager();this.getModel().submitBatch("$auto").then(function(r){var a=e.getModel("message").getData();var s=a.slice().reverse().find(e=>e.type==="Error");if(s){s&&i.error(s.message);e._refreshMessageManager();return}else{var n=e.oContext.getPath();var o=e.extractIdFromPath(n);e._refreshMessageManager();i.success(t.getText("templateSaved"));setTimeout(function(){e._fnReadExistingTemplate(o).then(function(t){e.getModel("appModel").setProperty("/Template/template_id",t.template_id)})},1e3)}})}else{this.getModel("oDataV2").read("/Templates("+r.ID+")?$expand=attribute_groups($select=ID,sortID)",{success:function(a){e.getModel("oDataV2").update("/Templates("+r.ID+")?$expand=attribute_groups($select=ID,sortID)",s,{success:function(e,r){i.success(t.getText("templateUpdated"))},error:function(e){i.error(`${e.message}: ${e.statusCode} ${JSON.parse(e.responseText).error.message.value}`)}})},error:function(e){i.error(t.getText("failedToReadTemplates"))}})}},extractIdFromPath:function(e){var t=e.match(/\(([^)]+)\)/);return t?t[1]:null},onDialogClose:function(e){let t=this.getResourceBundle();var r=e.getParameter("selectedContexts");if(r&&r.length){var a=[];var i=this.getModel("appModel");var n=i.getProperty("/AttributeGroups")||[];var o=new Map(n.map(e=>[e.name,e]));r.forEach(function(e){var t=e.getObject();if(o.has(t.name)&&o.get(t.name).Rank>0){}else{t.Rank=this._iRankCounter++;a.push(t.name);if(!o.has(t.name)){n.push(t)}}}.bind(this));var u=a.length;i.setProperty("/AttributeGroups",n);i.refresh();var n=i.getProperty("/AttributeGroups");var p=n.filter(function(e){return e.Rank>0}).length;var l=this.byId("tblAttrGrpTemplate");var d=l.getHeaderToolbar().getContent()[0];d.setText("Attribute Groups ("+p+")")}else{s.show(t.getText("templateNoNewItemSelected"))}var g=e.getSource();var f=g.getBinding("items");if(f){f.filter([])}else{console.error("Items binding not found.")}},onDeleteAttributeGroup:function(e){var t=e.getSource();var r=t.getBindingContext("appModel").getPath();var a=this.getModel("appModel");var s=a.getProperty("/AttributeGroups");var i=parseInt(r.split("/").pop(),10);if(s[i].sortID!==undefined){s.splice(i,1)}else{s[i].Rank=0}var n=s.filter(function(e){return e.Rank>0});n.forEach(function(e,t){e.Rank=t+1;if(e.sortID!==undefined){e.sortID=t+1}});s.forEach(function(e){if(e.Rank===0){var t=n.find(t=>t.ID===e.ID);if(!t){n.push(e)}}});a.setProperty("/AttributeGroups",n);var o=this.byId("attributeGroupsTitle");var u=n.filter(function(e){return e.Rank>0}).length;o.setText("Attribute Groups ("+u+")");a.refresh()}})});
//# sourceMappingURL=CreateTemplate.controller.js.map