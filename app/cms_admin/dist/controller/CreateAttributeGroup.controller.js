sap.ui.define(["./BaseController","sap/m/MessageToast","sap/m/MessageBox","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/thirdparty/jquery","sap/ui/model/Filter","sap/ui/model/FilterOperator","../model/formatter"],function(e,t,r,a,s,jquery,o,i,n){"use strict";return e.extend("com.dhi.cms.cmsadmin.controller.CreateAttributeGroup",{formatter:n,onInit:function(){this.getRouter().getRoute("Create Attribute Group").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:function(e){var t=e.getParameter("name");var r=e.getParameter("arguments");var a=r.attributeGroupId;var s=!!a;this.getModel("appModel").setProperty("/isEditMode",s);this.attributeGroupId=a;this._fnRegisterMessageManager();var o=s?this.getResourceBundle().getText("Update_Attribute_Group_Title"):this.getResourceBundle().getText("Create_Attribute_Group_Title");this.getView().byId("attributeGroupTitle").setText(o);debugger;if(a){this._fnReadExistingAttributeGroup(a)}else{this.getModel("appModel").setProperty("/AttributeGroup",[]);this.getModel("appModel").setProperty("/AssociatedAttributes",[])}this._fnRegisterMessageManager()},mergeAttributes:function(e,t){const r=new Map(e.map(e=>[e.name,e]));t.forEach(t=>{if(!r.has(t.name)){e.push({...t})}else{const e=r.get(t.name);Object.assign(e,t)}});return e},_fnReadAttributes:function(){debugger;var e=this;return new Promise(function(t,r){e.getModel("oDataV2").read("/Attributes",{success:function(r,a){var s=r.results;var o=e.getModel("appModel").getProperty("/AssociatedAttributes")||[];const i=new Map(o.map(e=>[e.name,e]));s.forEach(function(e){if(!i.has(e.name)){e.Rank=0}});var n=e.mergeAttributes(o,s);console.log("Merged Attributes:",n);e.getModel("appModel").setProperty("/AssociatedAttributes",n);t(n)},error:function(e){console.error("Error reading Attributes:",e);r(e)}})})},onSave:async function(){debugger;var e=true;var t=this.byId("attributeGrpNameInput");var r=this.byId("aliasNameInputAtrGrp");var a=this.byId("attributeGrpDescInput");var s=t.getValue();var o=r.getValue();var i=a.getValue();const n=t.getMaxLength?t.getMaxLength():50;if(!s||s.trim()===""){t.setValueState("Error");t.setValueStateText("This field is required.");e=false}else if(s.length>n){t.setValueState("Error");t.setValueStateText(`Name must be less than ${n} characters.`);e=false}else{t.setValueState("None")}const u=r.getMaxLength?r.getMaxLength():50;if(o&&o.length>u){r.setValueState("Error");r.setValueStateText(`Alias must be less than ${u} characters.`);e=false}else{r.setValueState("None")}const l=a.getMaxLength?a.getMaxLength():100;if(i.length>l){a.setValueState("Error");a.setValueStateText(`Description must be less than ${l} characters.`);e=false}else{a.setValueState("None")}if(e===true){var d=this.getView();d.setBusyIndicatorDelay(0);d.setBusy(true);try{await this.handleSaveAttributeGroup()}catch(e){console.error("Save failed:",e);d.setBusy(false)}await this.byId("attributeGrpNameInput").setValueState("None")}},handleSaveAttributeGroup:async function(){let e=this.getResourceBundle();var t=this;var a=this.getModel("appModel").getData().AttributeGroup;var s=this.getModel("appModel").getData().AssociatedAttributes;var o={name:a.name,alias:a.alias,desc:a.desc,attributes:[]};for(var i=0;i<s.length;i++){var n=s[i];if(n.Rank>0){var u={sortID:n.Rank};if(n.attribute&&n.attribute.ID){u.attribute_ID=n.attribute.ID}else{u.attribute_ID=n.ID}o.attributes.push(u)}}if(!Array.isArray(o.attributes)||o.attributes.length===0){r.error("Please add at least one attribute to the group.");throw new Error("No attributes to save.")}if(a.ID===undefined){var l=this.getView();this.getModel().resetChanges("$auto",true);var d=this.getModel().bindList("/Attribute_Groups",undefined,undefined,undefined,undefined);this.oContext=d.create(o,{bSkipRefresh:true});this._refreshMessageManager();this.getModel().submitBatch("$auto").then(function(a){var s=t.getModel("message").getData();var o=s.slice().reverse().find(e=>e.type==="Error");if(o){let e="";try{e=o.message}catch(t){e="An unexpected error occurred."}if(e&&e.toLowerCase().startsWith("unique constraint violated")){r.error("Enter Unique Attribute Group name")}else{r.error(`Error: ${e}`)}t._refreshMessageManager();l.setBusy(false);return}else{var i=t.oContext.getPath();var n=t.extractIdFromPath(i);t._refreshMessageManager();setTimeout(function(){t._fnReadExistingAttributeGroup(n).then(function(e){t.getModel("appModel").setProperty("/AttributeGroup/ID",e.ID)})},1e3);r.success(e.getText("attributeGroupSaveSuccess"),{actions:[r.Action.OK],onClose:function(e){if(e===r.Action.OK){t.onNavigation("Attribute Groups")}}});l.setBusy(false);debugger}})}else{var l=this.getView();this.getModel("oDataV2").read("/Attribute_Groups("+a.ID+")?$expand=attributes($select=ID,sortID;",{success:function(s){console.log("Existing data for Attribute Group ID:",a.ID,s);t.getModel("oDataV2").update("/Attribute_Groups("+a.ID+")?$expand=attributes($select=ID,sortID)",o,{success:function(a,s){r.success(e.getText("attributeGroupUpdateSuccess"),{actions:[r.Action.OK],onClose:function(e){if(e===r.Action.OK){t.onNavigation("Attribute Groups")}}});l.setBusy(false)},error:function(e){let t="";try{t=JSON.parse(e.responseText).error.message.value}catch(r){t=e.message||"An unexpected error occurred."}if(t&&t.toLowerCase().startsWith("unique constraint violated")){r.error("Enter Unique Attribute Group name")}else{r.error(`Error: ${t}`)}l.setBusy(false)}})},error:function(t){r.error(e.getText("attributeGroupReadError"));l.setBusy(false)}})}},extractIdFromPath:function(e){var t=e.match(/\(([^)]+)\)/);return t?t[1]:null},onAddAttributes:function(){var e=this;var t=this.getView();var r=this.getModel("appModel");var s=r.getProperty("/AssociatedAttributes")||[];t.setBusyIndicatorDelay(0);t.setBusy(true);this.getModel("oDataV2").read("/Attributes",{success:function(o){var i=o.results;var n=new Set(s.map(e=>e.name));var u=i.filter(e=>!n.has(e.name));r.setProperty("/AvailableAttributes",u);e._iRankCounter=s.length?Math.max(...s.map(e=>e.Rank))+1:1;if(!e._pDialog){e._pDialog=a.load({id:t.getId(),name:"com.dhi.cms.cmsadmin.fragments.attributegroups.AddAttributes",controller:e}).then(function(e){t.addDependent(e);return e})}e._pDialog.then(function(e){e.clearSelection();e.open();t.setBusy(false)})},error:function(){t.setBusy(false)}})},onSearchAttributes:function(e){var t=e.getParameter("value");var r=new o("name",i.Contains,t);var a=e.getParameter("itemsBinding");a.filter([r])},onDeleteAttribute:function(e){var t=e.getSource();var r=t.getBindingContext("appModel").getPath();var a=this.getModel("appModel");var s=a.getProperty("/AssociatedAttributes");var o=parseInt(r.split("/").pop(),10);s.splice(o,1);s.forEach(function(e,t){e.Rank=t+1;if(e.sortID!==undefined){e.sortID=t+1}});a.setProperty("/AssociatedAttributes",s);a.refresh()},onDialogClose:function(e){let r=this.getResourceBundle();var a=e.getParameter("selectedContexts");console.log("Dialog closed, selected contexts:",a);if(a&&a.length){var s=[];var o=this.getModel("appModel");console.log(o);var i=o.getProperty("/AssociatedAttributes")||[];var n=new Map(i.map(e=>[e.name,e]));a.forEach(function(e){var t=e.getObject();console.log("Selected Object:",t);if(n.has(t.name)&&n.get(t.name).Rank>0){console.log("Attribute already exists with Rank > 0, not updating Rank:",t.name)}else{console.log("Current Rank Counter:",this._iRankCounter);t.Rank=this._iRankCounter++;console.log("Updated Rank:",t.Rank);var r=i.some(e=>e.sortID!==undefined);if(r){t.sortID=t.Rank}console.log("Updated sortID:",t.sortID);console.log("New Rank Counter:",this._iRankCounter);s.push(t.name);if(!n.has(t.name)){i.push(t)}}}.bind(this));var u=s.length;console.log("total count of selected items",u);o.setProperty("/AssociatedAttributes",i);o.refresh();console.log("App model refreshed with updated ranks and added attributes.",o);var l=i.filter(function(e){return e.Rank>0}).length;var d=this.byId("tblAssociatedAttributes")}else{t.show(r.getText("attributeGroupNoNewItemSelected"))}var c=e.getSource();console.log("Event Source:",c);var g=c.getBinding("items");console.log("Items Binding before clearing filters:",g);if(g){g.filter([]);console.log("Filters cleared from items binding.")}else{console.error("Items binding not found.")}},onDropSelected:function(e){var t=this;var r=e.getParameter("draggedControl");var a=e.getParameter("droppedControl");var s=e.getParameter("dropPosition");var o=this.byId("tblAssociatedAttributes");var i=this.getView().getModel("appModel");var n=i.getProperty("/AssociatedAttributes");var u=n.filter(function(e){return e.Rank>0});var l=o.indexOfItem(r);var d=o.indexOfItem(a);if(s==="After"){d++}var c=u.splice(l,1)[0];u.splice(d,0,c);for(var g=0;g<u.length;g++){u[g].Rank=g+1;if(u[g].sortID!==undefined){u[g].sortID=u[g].Rank}}n.forEach(function(e){var t=u.find(function(t){return t.ID===e.ID});if(t){e.Rank=t.Rank;if(t.sortID!==undefined){e.sortID=t.Rank}}});i.setProperty("/AssociatedAttributes",u);console.log(n)},_fnReadExistingAttributeGroup:function(e){debugger;var t=this;var r="/Attribute_Groups("+e+")";var a={$expand:"templates($select=ID,sortID;$expand=templates($select=ID,name,desc)),attributes($select=ID,attribute,sortID;$expand=attribute($select=ID,attribute_id,name,desc))"};var s=this.getModel().bindContext(r,null,a);s.requestObject().then(function(e){if(Array.isArray(e.attributes)){e.attributes.forEach(function(e){e.Rank=e.sortID||0;if(e.attribute){e.name=e.attribute.name||"";e.desc=e.attribute.desc||""}else{e.name="";e.desc=""}});t.getModel("appModel").setProperty("/AttributeGroup",e);t.getModel("appModel").setProperty("/AssociatedAttributes",e.attributes)}console.log("Updated AttributeGroup data:",t.getModel("appModel").getProperty("/AttributeGroup"));console.log("Updated AssociatedAttributes data:",t.getModel("appModel").getProperty("/AssociatedAttributes"))})}})});
//# sourceMappingURL=CreateAttributeGroup.controller.js.map